---
title: "scRNA-seq Report for dataset: `r basename(params$app_data$user_inputs$dataset)`"
# author: "Generated from Shiny Application"
# date: "`r Sys.Date()`"
output: 
  html_document:
    theme: flatly
    toc: true
    toc_float: true
    code_folding: hide
    fig_width: 10
    fig_height: 6
params:
  app_data: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                     fig.align = 'center', out.width = '100%')
library(knitr)
library(DT)

# Access parameters
saved_plots <- params$app_data$saved_plots
canvas_info <- params$app_data$canvas_info
user_inputs <- params$app_data$user_inputs
timestamp <- params$app_data$timestamp
scatter_data <- params$app_data$scatter_data
qc_plot_data <- params$app_data$qc_plot_data
```

**Generated on:** `r format(timestamp, "%Y-%m-%d %H:%M:%S")`

The [Bioinformatics Resource Center](https://rockefelleruniversity.github.io/) scRNA-seq Browser provides an interactive platform for exploring single-cell RNA sequencing data. This report summarizes the key visualizations and analyses performed during your session.

This report was written by [George MuÃ±oz](https://github.com/george123ya) at the Rockefeller University Bioinformatics Resource Center with contributions by [Luis Soto-Ugaldi](https://github.com/SotoLF), [Doug Barrows](https://github.com/dougbarrows) and [Thomas Carroll](https://github.com/ThomasCarroll) from the BRC.

## Visualization Results

```{r heatmap-section-header, eval=!is.null(saved_plots$heatmap1) || !is.null(saved_plots$heatmap2), results='asis'}
cat("### Heatmap Visualizations\n\n")
```

```{r heatmap1-header, eval=!is.null(saved_plots$heatmap1), results='asis'}
cat("#### Individual Genes\n\n")
```

```{r heatmap1-details, eval=!is.null(saved_plots$heatmap1), results='asis'}
if(!is.null(user_inputs$heatmap_genes_panel1)) {
  cat("**Input Parameters:**\n\n")
  cat("- **Genes:**", user_inputs$heatmap_genes_panel1, "\n")
  cat("- **Score Type:**", user_inputs$heatmap_score_panel1, "\n")
  cat("- **Cell Grouping Mode:**", user_inputs$heatmap_cell_group_mode_panel1, "\n")
  cat("- **Cluster/Color By:**", ifelse(is.null(user_inputs$heatmap_cluster_by_panel1), "None", user_inputs$heatmap_cluster_by_panel1), "\n\n")
  
  cat("**Reproducible Code:**\n\n")
  cat("```r\n")
  cat("# Load required libraries\n")
  cat("library(zarr)\n")
  cat("library(reticulate)\n")
  cat("library(ComplexHeatmap)\n")
  cat("library(circlize)\n\n")
  
  cat("# Load analysis functions\n")
  cat("source('https://raw.githubusercontent.com/george123ya/scRNAseq_Visualizer/main/modules/reproducible_functions.R')\n\n")
  
  cat("# Initialize zarr data connection\n")
  cat("zarr_path <- '", ifelse(grepl("^https?://", user_inputs$dataset), user_inputs$dataset, "path/to/your/dataset.zarr"), "'\n")
  cat("zarr_root <- zarr$open_group(zarr_path, mode='r')\n\n")
  
  cat("# Retrieve genes from zarr\n")
  genes_clean <- trimws(unlist(strsplit(user_inputs$heatmap_genes_panel1, ",|\\s+")))
  genes_clean <- genes_clean[genes_clean != "" & !is.na(genes_clean)]
  cat("requested_genes <- c(", paste(paste0("\"", genes_clean, "\""), collapse = ", "), ")\n")
  cat("available_genes <- zarr_root$var$index$values\n")
  cat("genes <- requested_genes[toupper(requested_genes) %in% toupper(available_genes)]\n\n")
  
  cat("# Extract expression matrix from zarr\n")
  cat("expr_indices <- match(toupper(genes), toupper(available_genes))\n")
  cat("expr_matrix <- zarr_root$X[, expr_indices]\n")
  cat("colnames(expr_matrix) <- genes\n\n")
  
  cat("# Get cell metadata from zarr\n")
  cat("cell_metadata <- data.frame(\n")
  cat("  cell_id = zarr_root$obs$index$values\n")
  if(!is.null(user_inputs$heatmap_cluster_by_panel1) && user_inputs$heatmap_cluster_by_panel1 != "") {
    cat(",\n  cluster = zarr_root$obs$", user_inputs$heatmap_cluster_by_panel1, "$values\n")
  }
  cat(")\n\n")
  
  cat("# Process heatmap data using zarr-retrieved information\n")
  cat("heatmap_data <- process_heatmap_data(\n")
  cat("  expr_matrix = expr_matrix,\n")
  cat("  cell_metadata = cell_metadata,\n")
  cat("  score_type = '", user_inputs$heatmap_score_panel1, "',\n")
  cat("  cell_group_mode = '", user_inputs$heatmap_cell_group_mode_panel1, "',\n")
  cat("  cluster_by = '", ifelse(is.null(user_inputs$heatmap_cluster_by_panel1), "", user_inputs$heatmap_cluster_by_panel1), "'\n")
  cat(")\n\n")
  
  cat("# Generate heatmap (using data from R params for actual plotting)\n")
  cat("# Note: The heatmap is plotted using pre-computed data from the Shiny app\n")
  cat("# but the zarr retrieval code above shows how to reproduce the analysis\n")
  cat("```\n\n")
  
  cat("ðŸ”— **Functions Source:** https://github.com/george123ya/scRNAseq_Visualizer/blob/main/modules/reproducible_functions.R\n\n")
}
```

```{r heatmap1-plot, eval=!is.null(saved_plots$heatmap1)}
include_graphics(normalizePath(saved_plots$heatmap1))
```

```{r heatmap2-header, eval=!is.null(saved_plots$heatmap2), results='asis'}
cat("#### Gene Sets / Pathways\n\n")
```

```{r heatmap2-details, eval=!is.null(saved_plots$heatmap2), results='asis'}
if(!is.null(user_inputs$heatmap_gene_group_mode_panel2)) {
  cat("**Input Parameters:**\n\n")
  cat("- **Gene Group Mode:**", user_inputs$heatmap_gene_group_mode_panel2, "\n")
  cat("- **Score Type:**", user_inputs$heatmap_score_panel2, "\n")
  cat("- **Cell Grouping Mode:**", user_inputs$heatmap_cell_group_mode_panel2, "\n")
  cat("- **Cluster/Color By:**", ifelse(is.null(user_inputs$heatmap_cluster_by_panel2), "None", user_inputs$heatmap_cluster_by_panel2), "\n")
  
  # Show specific selections based on mode
  if(user_inputs$heatmap_gene_group_mode_panel2 == "pathways" && !is.null(user_inputs$heatmap_pathway_select_panel2)) {
    cat("- **Selected Pathways:**", paste(user_inputs$heatmap_pathway_select_panel2, collapse=", "), "\n")
  } else if(user_inputs$heatmap_gene_group_mode_panel2 == "custom_gmt" && !is.null(user_inputs$heatmap_gmt_sets_panel2)) {
    cat("- **Selected GMT Gene Sets:**", paste(user_inputs$heatmap_gmt_sets_panel2, collapse=", "), "\n")
  } else if(user_inputs$heatmap_gene_group_mode_panel2 == "manual" && !is.null(user_inputs$selected_manual_genesets)) {
    cat("- **Selected Manual Gene Sets:**", paste(user_inputs$selected_manual_genesets, collapse=", "), "\n")
  }
  cat("\n")
  
  cat("**Reproducible Code:**\n\n")
  cat("```r\n")
  cat("# Load required libraries\n")
  cat("library(zarr)\n")
  cat("library(reticulate)\n")
  cat("library(ComplexHeatmap)\n\n")
  
  cat("# Load analysis functions\n")
  cat("source('https://raw.githubusercontent.com/george123ya/scRNAseq_Visualizer/main/modules/reproducible_functions.R')\n\n")
  
  cat("# Initialize zarr data connection\n")
  cat("zarr_path <- '", ifelse(grepl("^https?://", user_inputs$dataset), user_inputs$dataset, "path/to/your/dataset.zarr"), "'\n")
  cat("zarr_root <- zarr$open_group(zarr_path, mode='r')\n\n")
  
  cat("# Retrieve gene lists and metadata from zarr\n")
  cat("available_genes <- zarr_root$var$index$values\n")
  cat("cell_metadata <- data.frame(\n")
  cat("  cell_id = zarr_root$obs$index$values\n")
  if(!is.null(user_inputs$heatmap_cluster_by_panel2) && user_inputs$heatmap_cluster_by_panel2 != "") {
    cat(",\n  cluster = zarr_root$obs$", user_inputs$heatmap_cluster_by_panel2, "$values\n")
  }
  cat(")\n\n")
  
  if(user_inputs$heatmap_gene_group_mode_panel2 == "pathways") {
    cat("# Load pathway data from zarr\n")
    cat("if('uns' %in% names(zarr_root) && 'pathways' %in% names(zarr_root$uns)) {\n")
    cat("  pathway_data <- zarr_root$uns$pathways\n")
    cat("} else {\n")
    cat("  # Load from external source or define manually\n")
    cat("  pathway_data <- load_pathway_database()\n")
    cat("}\n")
    if("ALL" %in% user_inputs$heatmap_pathway_select_panel2) {
      cat("gene_groups <- pathway_data  # All pathways selected\n")
    } else {
      cat("selected_pathways <- c(", paste(paste0("\"", user_inputs$heatmap_pathway_select_panel2, "\""), collapse=","), ")\n")
      cat("gene_groups <- pathway_data[selected_pathways]\n")
    }
  } else if(user_inputs$heatmap_gene_group_mode_panel2 == "custom_gmt") {
    cat("# Load GMT file data\n")
    cat("gmt_data <- parse_gmt_file('path/to/your/geneset.gmt')\n")
    if("ALL" %in% user_inputs$heatmap_gmt_sets_panel2) {
      cat("gene_groups <- gmt_data  # All GMT gene sets selected\n")
    } else {
      cat("selected_gmt <- c(", paste(paste0("\"", user_inputs$heatmap_gmt_sets_panel2, "\""), collapse=","), ")\n")
      cat("gene_groups <- gmt_data[selected_gmt]\n")
    }
  } else if(user_inputs$heatmap_gene_group_mode_panel2 == "manual") {
    cat("# Define manual gene sets\n")
    cat("gene_groups <- list(\n")
    if(!is.null(user_inputs$selected_manual_genesets)) {
      for(i in seq_along(user_inputs$selected_manual_genesets)) {
        cat("  \"", user_inputs$selected_manual_genesets[i], "\" = c(\"GENE1\", \"GENE2\", \"GENE3\")")
        if(i < length(user_inputs$selected_manual_genesets)) cat(",")
        cat("\n")
      }
    }
    cat(")\n")
  }
  
  cat("\n# Extract expression data from zarr for gene sets\n")
  cat("expr_data_list <- lapply(gene_groups, function(genes) {\n")
  cat("  valid_genes <- genes[toupper(genes) %in% toupper(available_genes)]\n")
  cat("  if(length(valid_genes) == 0) return(NULL)\n")
  cat("  gene_indices <- match(toupper(valid_genes), toupper(available_genes))\n")
  cat("  zarr_root$X[, gene_indices, drop=FALSE]\n")
  cat("})\n\n")
  
  cat("# Calculate gene set scores and create heatmap\n")
  cat("heatmap_data <- calculate_geneset_scores(\n")
  cat("  expr_data_list = expr_data_list,\n")
  cat("  cell_metadata = cell_metadata,\n")
  cat("  score_type = '", user_inputs$heatmap_score_panel2, "',\n")
  cat("  cell_group_mode = '", user_inputs$heatmap_cell_group_mode_panel2, "',\n")
  cat("  cluster_by = '", ifelse(is.null(user_inputs$heatmap_cluster_by_panel2), "", user_inputs$heatmap_cluster_by_panel2), "'\n")
  cat(")\n\n")
  
  cat("# Generate heatmap (using data from R params for actual plotting)\n")
  cat("# Note: The heatmap is plotted using pre-computed data from the Shiny app\n")
  cat("# but the zarr retrieval code above shows how to reproduce the analysis\n")
  cat("```\n\n")
  
  cat("ðŸ”— **Functions Source:** https://github.com/george123ya/scRNAseq_Visualizer/blob/main/modules/reproducible_functions.R\n\n")
}
```

```{r heatmap2-plot, eval=!is.null(saved_plots$heatmap2)}
include_graphics(normalizePath(saved_plots$heatmap2))
```


```{r gene-section-header, eval=!is.null(saved_plots$gene_main), results='asis'}
cat("### Gene Expression Analysis\n\n")
```

```{r gene-analysis-header, eval=!is.null(saved_plots$gene_main), results='asis'}
cat("#### Main Gene Analysis Plot\n\n")
```

```{r gene-plot-details, eval=!is.null(saved_plots$gene_main), results='asis'}
if(!is.null(user_inputs$geneSearch_tab)) {
  cat("**Input Parameters:**\n\n")
  cat("- **Selected Genes:**", paste(user_inputs$geneSearch_tab, collapse=", "), "\n")
  cat("- **Group By:**", user_inputs$gene_group_by, "\n")
  cat("- **Plot Type:**", user_inputs$gene_plot_type, "\n")
  cat("- **Show Points:**", user_inputs$gene_show_points, "\n")
  cat("- **Point Size:**", user_inputs$gene_point_size, "\n")
  cat("- **Log Scale:**", user_inputs$gene_log_scale, "\n\n")
  
  cat("**Reproducible Code:**\n\n")
  cat("```r\n")
  cat("# Load required libraries\n")
  cat("library(zarr)\n")
  cat("library(reticulate)\n")
  cat("library(ggplot2)\n")
  cat("library(reshape2)\n\n")
  
  cat("# Load analysis functions\n")
  cat("source('https://raw.githubusercontent.com/george123ya/scRNAseq_Visualizer/main/modules/reproducible_functions.R')\n\n")
  
  cat("# Initialize zarr data connection\n")
  cat("zarr_path <- '", ifelse(grepl("^https?://", user_inputs$dataset), user_inputs$dataset, "path/to/your/dataset.zarr"), "'\n")
  cat("zarr_root <- zarr$open_group(zarr_path, mode='r')\n\n")
  
  cat("# Retrieve gene information from zarr\n")
  genes_clean <- trimws(user_inputs$geneSearch_tab)
  genes_clean <- genes_clean[genes_clean != "" & !is.na(genes_clean)]
  cat("requested_genes <- c(", paste(paste0("\"", genes_clean, "\""), collapse = ", "), ")\n")
  cat("available_genes <- zarr_root$var$index$values\n")
  cat("genes <- requested_genes[toupper(requested_genes) %in% toupper(available_genes)]\n\n")
  
  cat("# Extract expression data from zarr\n")
  cat("gene_indices <- match(toupper(genes), toupper(available_genes))\n")
  cat("expr_matrix <- zarr_root$X[, gene_indices, drop=FALSE]\n")
  cat("colnames(expr_matrix) <- genes\n\n")
  
  cat("# Get grouping variable from zarr\n")
  cat("group_var <- zarr_root$obs$", user_inputs$gene_group_by, "$values\n")
  cat("group_var <- as.factor(group_var)\n\n")
  
  cat("# Build data frame for plotting (using data from R params)\n")
  cat("# Note: The actual plotting uses pre-computed data from the Shiny app\n")
  cat("# but the zarr retrieval code above shows how to reproduce the analysis\n\n")
  
  cat("```\n\n")
  
  cat("ðŸ”— **Functions Source:** https://github.com/george123ya/scRNAseq_Visualizer/blob/main/modules/reproducible_functions.R\n\n")
}
```

```{r gene-analysis-plot, eval=!is.null(saved_plots$gene_main)}
include_graphics(normalizePath(saved_plots$gene_main))
```

```{r gene-analysis-text, eval=!is.null(saved_plots$gene_main), results='asis'}
cat("\n\nThis plot shows the main gene expression analysis results using data retrieved from zarr but plotted with R.\n")
```

```{r violin-plots-header, eval=length(params$app_data$violin_genes) > 0, results='asis'}
cat("#### Individual Gene Violin Plots\n\n")
```

```{r violin-plots, eval=length(params$app_data$violin_genes) > 0, results='asis'}
if (length(params$app_data$violin_genes) > 0) {
  for (gene in params$app_data$violin_genes) {
    plot_name <- paste0("violin_", gene)
    if (!is.null(params$app_data$saved_plots[[plot_name]])) {
      cat(sprintf("##### %s\n", gene))
      cat(sprintf("![%s](%s){width=80%%}\n\n", plot_name, normalizePath(params$app_data$saved_plots[[plot_name]])))
    }
  }
} else {
  cat("No individual violin plots available.\n\n")
}
```

```{r qc-section-header, eval=!is.null(saved_plots$qc_main), results='asis'}
cat("### Quality Control\n\n")
```

```{r qc-analysis-header, eval=!is.null(saved_plots$qc_main), results='asis'}
cat("#### Quality Control Plot\n\n")
```

```{r qc-plot-details, eval=!is.null(saved_plots$qc_main), results='asis'}
if(!is.null(user_inputs$qc_plot_type)) {
  cat("**Input Parameters:**\n\n")
  cat("- **Plot Type:**", user_inputs$qc_plot_type, "\n")
  if(user_inputs$qc_plot_type == "scatter") {
    cat("- **X Metric:**", user_inputs$qc_x_metric, "\n")
    cat("- **Y Metric:**", user_inputs$qc_y_metric, "\n")
    cat("- **Color By:**", ifelse(is.null(user_inputs$qc_color_by) || user_inputs$qc_color_by == "None", "None", user_inputs$qc_color_by), "\n")
  } else {
    cat("- **Metric:**", user_inputs$qc_metric, "\n")
    cat("- **Group By:**", user_inputs$qc_group_by, "\n")
  }
  cat("- **Show Points (Violin/Box):**", user_inputs$qc_show_points, "\n")
  cat("- **Point Size:**", user_inputs$qc_point_size, "\n")
  cat("- **Log Scale:**", user_inputs$qc_log_scale, "\n\n")
  
  cat("**Reproducible Code:**\n\n")
  cat("```r\n")
  cat("# Load required libraries\n")
  cat("library(zarr)\n")
  cat("library(reticulate)\n")
  cat("library(ggplot2)\n\n")
  
  cat("# Load analysis functions\n")
  cat("source('https://raw.githubusercontent.com/george123ya/scRNAseq_Visualizer/main/modules/reproducible_functions.R')\n\n")
  
  cat("# Initialize zarr data connection\n")
  cat("zarr_path <- '", ifelse(grepl("^https?://", user_inputs$dataset), user_inputs$dataset, "path/to/your/dataset.zarr"), "'\n")
  cat("zarr_root <- zarr$open_group(zarr_path, mode='r')\n\n")
  
  if(user_inputs$qc_plot_type == "scatter") {
    cat("# Retrieve QC metrics from zarr observations\n")
    cat("x_metric <- zarr_root$obs$", user_inputs$qc_x_metric, "$values\n")
    cat("y_metric <- zarr_root$obs$", user_inputs$qc_y_metric, "$values\n")
    if(!is.null(user_inputs$qc_color_by) && user_inputs$qc_color_by != "None") {
      cat("color_metric <- zarr_root$obs$", user_inputs$qc_color_by, "$values\n")
    }
  } else {
    cat("# Retrieve QC metrics from zarr observations\n")
    cat("qc_metric <- zarr_root$obs$", user_inputs$qc_metric, "$values\n")
    cat("group_metric <- zarr_root$obs$", user_inputs$qc_group_by, "$values\n")
  }
  
  cat("\n# Note: The actual plotting uses pre-computed data from the Shiny app\n")
  cat("# but the zarr retrieval code above shows how to reproduce the analysis\n\n")
  
  cat("```\n\n")
  
  cat("ðŸ”— **Functions Source:** https://github.com/george123ya/scRNAseq_Visualizer/blob/main/modules/reproducible_functions.R\n\n")
}
```

```{r qc-analysis-plot, eval=!is.null(saved_plots$qc_main)}
# Use pre-computed data from R params for plotting, but show zarr retrieval in code
if(!is.null(qc_plot_data) && exists("user_inputs")) {
  library(reglScatterplot)
  
  if(user_inputs$qc_plot_type == "scatter") {
    # Use the qc_plot_data from R params for actual plotting
    my_scatterplot(
      x = qc_plot_data$data$X,
      y = qc_plot_data$data$Y,
      colorBy = if(!is.null(user_inputs$qc_color_by) && user_inputs$qc_color_by != "None") qc_plot_data$data[[user_inputs$qc_color_by]] else NULL,
      size = user_inputs$qc_point_size,
      xlab = user_inputs$qc_x_metric,
      ylab = user_inputs$qc_y_metric
    )
  } else {
    # Use the qc_plot_data from R params for actual plotting
    my_violinplot(
      data = qc_plot_data$data,
      value = user_inputs$qc_metric,
      group = user_inputs$qc_group_by,
      showPoints = user_inputs$qc_show_points,
      pointSize = user_inputs$qc_point_size,
      ylab = user_inputs$qc_metric
    )
  }
}
```

```{r qc-analysis-text, eval=!is.null(saved_plots$qc_main), results='asis'}
cat("\n\nThis plot displays the quality control metrics using zarr-retrieved metadata but plotted with R data.\n")
```

```{r canvas-section-header, results='asis'}
# Check if any canvas plots exist
canvas_plots <- saved_plots[grepl("canvas", names(saved_plots))]
if(length(canvas_plots) > 0) {
  cat("## Interactive Canvas Elements\n\n")
}
```

```{r scatterplot-canvas-header, eval=!is.null(scatter_data[['main']]), results='asis'}
cat("### Scatterplot Canvas\n\n")
cat("#### Main Scatterplot Canvas\n\n")
cat("**Reproducible Code (zarr data retrieval):**\n\n")
cat("```r\n")
cat("# Load required libraries\n")
cat("library(zarr)\n")
cat("library(reticulate)\n")
cat("library(reglScatterplot)\n\n")

cat("# Initialize zarr data connection\n")
cat("zarr_path <- '", ifelse(grepl("^https?://", user_inputs$dataset), user_inputs$dataset, "path/to/your/dataset.zarr"), "'\n")
cat("zarr_root <- zarr$open_group(zarr_path, mode='r')\n\n")

cat("# Retrieve coordinates from zarr (e.g., UMAP, t-SNE)\n")
cat("# Assuming coordinates are stored in obsm\n")
cat("if('obsm' %in% names(zarr_root) && 'X_umap' %in% names(zarr_root$obsm)) {\n")
cat("  coords <- zarr_root$obsm$X_umap[]\n")
cat("  x_coords <- coords[, 1]\n")
cat("  y_coords <- coords[, 2]\n")
cat("} else {\n")
cat("  # Use alternative coordinates or generate them\n")
cat("  x_coords <- zarr_root$obs$x_coord$values\n")
cat("  y_coords <- zarr_root$obs$y_coord$values\n")
cat("}\n\n")

cat("# Retrieve annotations from zarr\n")
cat("annotations <- zarr_root$obs$cluster$values  # or relevant annotation column\n\n")

cat("# Note: The actual plotting uses pre-computed data from the Shiny app\n")
cat("```\n\n")
```

```{r scatterplot-canvas-plot, eval=!is.null(scatter_data[['main']])}
# Use pre-computed scatter data from R params for actual plotting
library(reglScatterplot)
main_scatter_data <- scatter_data[['main']]

my_scatterplot(
  x = main_scatter_data$x,
  y = main_scatter_data$y,
  color = main_scatter_data$annotations,
  showAxes = FALSE
)
```

```{r scatterplot-canvas-text, eval=!is.null(saved_plots$scatterplot_canvas), results='asis'}
cat("\n\nThis plot represents the interactive scatterplot canvas with coordinates and annotations retrieved from zarr but plotted using R data.\n")
```

```{r gene-canvas-header, results='asis'}
gene_canvases <- saved_plots[grepl("^gene_canvas_", names(saved_plots))]
if(length(gene_canvases) > 0) {
  cat("### Gene-Specific Canvas Plots\n\n")
  cat("The following plots show gene expression overlaid on the main coordinates, with data retrieved from zarr but plotted using R:\n\n")
}
```

```{r gene-canvas-plots, results='asis', echo=FALSE}
library(reglScatterplot)

# Get gene keys from saved scatter data (excluding 'main')
gene_keys <- names(scatter_data)[names(scatter_data) != "main"]
if(length(gene_keys) > 0) {
  for(i in seq_along(gene_keys)) {
    gene_name <- gene_keys[i]
    
    # Skip if no data for this gene
    if(is.null(scatter_data[[gene_name]]) || nrow(scatter_data[[gene_name]]) == 0) {
      next
    }
    
    # Output the header
    cat(sprintf("#### %s {#gene-%s}\n\n", gene_name, gsub("[^A-Za-z0-9]", "-", gene_name)))
    
    # Show the reproducible code for zarr retrieval
    cat("**Reproducible Code (zarr data retrieval):**\n\n")
    cat("```r\n")
    cat("library(zarr)\n")
    cat("library(reticulate)\n")
    cat("library(reglScatterplot)\n\n")
    
    cat("# Initialize zarr connection\n")
    cat("zarr_path <- 'path/to/your/dataset.zarr'\n")
    cat("zarr_root <- zarr$open_group(zarr_path, mode='r')\n\n")
    
    cat("# Retrieve gene expression from zarr\n")
    cat(sprintf("gene_name <- '%s'\n", gene_name))
    cat("available_genes <- zarr_root$var$index$values\n")
    cat("gene_index <- match(toupper(gene_name), toupper(available_genes))\n")
    cat("gene_expression <- zarr_root$X[, gene_index]\n\n")
    
    cat("# Retrieve coordinates from zarr\n")
    cat("if('obsm' %in% names(zarr_root) && 'X_umap' %in% names(zarr_root$obsm)) {\n")
    cat("  coords <- zarr_root$obsm$X_umap[]\n")
    cat("  x_coords <- coords[, 1]\n")
    cat("  y_coords <- coords[, 2]\n")
    cat("} else {\n")
    cat("  x_coords <- zarr_root$obs$x_coord$values\n")
    cat("  y_coords <- zarr_root$obs$y_coord$values\n")
    cat("}\n\n")
    
    cat("# Create gene expression scatterplot\n")
    cat("my_scatterplot(\n")
    cat("  x = x_coords,\n")
    cat("  y = y_coords,\n")
    cat("  color = gene_expression,\n")
    cat("  showAxes = FALSE\n")
    cat(")\n")
    cat("```\n\n")
    
    # Get the gene data
    gene_data <- scatter_data[[gene_name]]
    
    # Create the plot using R data
    plot_obj <- my_scatterplot(
      x = gene_data$x,
      y = gene_data$y,
      color = gene_data$annotations,
      showAxes = FALSE
    )
    
    # Use htmltools to render properly in loops
    if(requireNamespace("htmltools", quietly = TRUE)) {
      cat(as.character(htmltools::div(plot_obj, class = paste0("gene-plot-", i))))
    } else {
      print(plot_obj)
    }
    
    cat("\n\n")
    
    # Add description
    cat(sprintf("This interactive scatterplot shows %s expression with coordinates and expression data retrieved from zarr but plotted using R data.\n\n", gene_name))
  }
} else {
  cat("No gene plots available.\n\n")
}
```

## Data Processing Summary

```{r processing-summary, results='asis'}
total_plots <- length(saved_plots)
total_canvases <- length(saved_plots[grepl("^scatterplot_canvas|^gene_canvas_", names(saved_plots))])

cat("### Analysis Summary\n\n")
cat("- **Static plots generated (including canvas snapshots):** ", total_plots, "\n")
cat("- **Interactive canvases captured:** ", total_canvases, "\n")
cat("- **Report generation time:** ", format(timestamp, "%Y-%m-%d %H:%M:%S"), "\n")
cat("- **Data retrieval method:** Zarr-based data access with R plotting\n\n")
```

## Reproducibility Notes

```{r reproducibility-notes, results='asis'}
cat("### Data Access Strategy\n\n")
cat("This report demonstrates a hybrid approach:\n\n")
cat("- **Data Retrieval:** All reproducible code examples show how to access data directly from zarr files using the `zarr` R package\n")
cat("- **Plotting:** Actual plots in this report use pre-computed data passed from the Shiny application for performance and consistency\n")
cat("- **Reproducibility:** Users can reproduce the analysis by following the zarr data retrieval code and applying the same processing functions\n\n")

cat("### Required R Packages for Reproduction\n\n")
cat("```r\n")
cat("# Install required packages if not already installed\n")
cat("if(!require(zarr)) install.packages('zarr')\n")
cat("if(!require(reticulate)) install.packages('reticulate')\n")
cat("if(!require(ggplot2)) install.packages('ggplot2')\n")
cat("if(!require(ComplexHeatmap)) BiocManager::install('ComplexHeatmap')\n")
cat("if(!require(reglScatterplot)) {\n")
cat("  # Install from GitHub or appropriate source\n")
cat("  devtools::install_github('your-repo/reglScatterplot')\n")
cat("}\n")
cat("```\n\n")

cat("### Python Dependencies (via reticulate)\n\n")
cat("The zarr functionality requires Python with zarr package:\n\n")
cat("```python\n")
cat("# Install zarr in Python environment\n")
cat("pip install zarr\n")
cat("```\n\n")
```

## Technical Information

```{r tech-info}
cat("### Session Information\n\n")
cat("R version:", R.version.string, "\n")
cat("Platform:", R.version$platform, "\n")
cat("Report generated using: rmarkdown and knitr\n")
cat("Data access: Zarr-based retrieval with R plotting\n")
```

---

*This report was automatically generated from your Shiny application. The reproducible code examples show how to access data directly from zarr files, while the actual plots use pre-computed data from the application for optimal performance. For interactive features and real-time updates, please return to the application interface.*